'use strict';
/**
 * Created by Michael Yakubov on 06/06/2016.
 */

module.exports = function createWithAudit(req, model, data, cb) {
    var Model = model;
    var user = req.appUser;
    var usedIp = req.ip;

    // Create new instance of model using data from params
    logger.info('[Audit][create] data: ', data);
    Model.create(data).exec(function created (err, newInstance) {
        if (!err) {
            AuditRecord.create({
                action: 'create',
                user: user,
                usedIp: usedIp,
                collection: Model.adapter.collection,
                document: newInstance.id,
                data: data
            }).exec(function (error) {
                var var1 = null;
                if (error) {
                    var var2;
                    error.ebsCode = errorCodes.CREATE_AUDIT_FAILED;
                    logger.error('Failed to audit creation of %s by user %s at IP %s', Model.adapter.collection, user.name, usedIp, error);
                } else {
                    var var3;
                    logger.info('Audited creation of %s by user %s at IP %s', Model.adapter.collection, user.name, usedIp);
                }
            });
        }

        cb(err, newInstance);
    });
};
